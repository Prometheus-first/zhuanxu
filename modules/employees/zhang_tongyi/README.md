# 张童义森 - 留存分析功能

## 📈 功能概述

留存分析功能已成功集成到张童义森的工作台中，提供完整的用户留存数据分析能力。

## 🚀 功能特性

### 1. 数据处理与存储
- **文件上传**: 支持 Excel (.xlsx, .xls) 和 CSV 格式
- **数据清洗**: 自动处理访问时间格式和访问时长数据
- **数据合并**: 按 IP + 地域 + 日期 自动合并重复记录
- **MongoDB存储**: 数据存储在专用的"留存"数据库中

### 2. 留存分析 🚧
- **状态**: 正在开发中，待新逻辑完成
- **界面**: 保留基础框架和按钮
- **功能**: 暂时不可用，显示开发中提示

## 📁 文件结构

```
modules/employees/zhang_tongyi/
├── README.md          # 功能说明文档
└── 匹配.py           # 原始功能代码（备份）
```

## 🔧 技术实现

### 后端组件
- `services/retention_service.py` - 留存分析业务逻辑
- `routes/retention_routes.py` - API路由处理
- `app.py` - 蓝图注册和路由配置

### 前端组件
- `static/retention-analysis.html` - 留存分析界面
- `static/dashboard.html` - 集成到主导航菜单

### 数据库
- **数据库**: `留存`
- **集合**: `数据`
- **连接**: MongoDB localhost:27017

## 🎯 使用方法

### 1. 登录系统
使用张童义森账号登录：
- 用户名: `zhangtongyi`
- 密码: `zt123456`

### 2. 访问留存分析
在左侧导航菜单中点击 "📈 留存分析"

### 3. 数据处理（可选）
如果需要上传新的数据文件：
1. 点击上传区域或拖拽文件
2. 选择 Excel 或 CSV 格式的数据文件
3. 点击"处理并存储数据"按钮
4. 等待数据处理完成，查看处理统计

### 4. 留存分析（开发中）🚧
当前状态：
1. 界面框架完整保留
2. 日期选择器正常工作
3. 点击"开始留存分析"按钮会显示开发中提示
4. 等待新的留存分析逻辑完成后重新开放功能

### 5. 数据概览
点击"查看数据概览"按钮可以查看数据库中的数据统计信息

### 6. 功能说明
- **数据处理**：独立的数据上传和存储功能，不依赖留存分析
- **留存分析**：独立的分析功能，基于数据库中的所有数据
- **两个功能可以单独使用**：可以只做留存分析而不上传新数据

## 📊 数据格式要求

上传的数据文件应包含以下字段：
- `访问时间`: 格式为 'YYYY-MM-DD HH:MM:SS'
- `访问ip`: 用户IP地址
- `地域`: 用户地域信息
- `访问时长`: 访问时长（秒），支持"未知"值
- 其他字段: 来源、关键词、搜索词、入口界面、系统、浏览器等

## 🔍 分析逻辑

### 数据处理
1. **时间格式化**: 将访问时间转换为标准datetime格式
2. **时长处理**: 将"未知"、空值转换为0
3. **数据合并**: 按IP+地域+日期分组，合并同一用户同一天的多次访问
4. **统计计算**: 计算访问次数、总时长、时间范围等

### 留存计算
1. **用户识别**: 使用IP+地域作为用户唯一标识
2. **日期分组**: 按访问日期对用户进行分组
3. **留存对比**: 计算每个基准日期与后续日期的用户重叠情况
4. **留存率**: 留存用户数 / 基准日用户数 × 100%

## 🛠️ API接口

### 数据上传
```
POST /api/retention/upload-data
Content-Type: multipart/form-data
Authorization: Bearer <token>

Body: file (Excel/CSV文件)
```

### 留存分析
```
POST /api/retention/analyze
Content-Type: application/json
Authorization: Bearer <token>

Body: {
  "start_date": "2025-07-17",  // 可选
  "end_date": "2025-07-27"     // 可选
}
```

### 数据概览
```
GET /api/retention/data-summary
Authorization: Bearer <token>
```

## 🔒 权限要求

- **登录权限**: 需要有效的JWT令牌
- **功能权限**: 需要 `data.process` 权限（员工角色自动拥有）

## 📝 注意事项

1. **数据库连接**: 确保MongoDB服务正在运行
2. **文件大小**: 建议上传文件不超过50MB
3. **数据质量**: 确保数据文件包含必要的字段
4. **日期格式**: 访问时间必须是标准格式
5. **权限验证**: 只有张童义森账号可以访问此功能

## 🐛 故障排除

### 常见问题
1. **上传失败**: 检查文件格式和大小
2. **分析无结果**: 确认数据库中有数据且日期范围正确
3. **权限错误**: 确认使用正确的账号登录
4. **连接失败**: 检查MongoDB服务状态

### 日志查看
查看Flask应用日志获取详细错误信息：
```bash
python app.py
```

---

*功能开发完成时间: 2025-07-21*  
*开发者: Augment Agent*  
*版本: v1.0*
